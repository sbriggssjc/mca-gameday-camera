<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-3">
<div class="container">
    <h1 class="mb-4">Live Play Dashboard</h1>
    <div class="row">
        <div class="col-md-4">
            <h3>Scoreboard</h3>
            <form id="score-form" class="mb-2">
                <div class="input-group mb-2">
                    <span class="input-group-text">MCA</span>
                    <input type="number" class="form-control" id="mca-score" value="{{ score['MCA'] }}">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Opp</span>
                    <input type="number" class="form-control" id="opp-score" value="{{ score['Opp'] }}">
                </div>
                <button class="btn btn-primary" type="submit">Update</button>
            </form>
            <p id="score-display" class="fw-bold fs-4"></p>
        </div>
        <div class="col-md-8">
            <h3>Play Call Breakdown</h3>
            <canvas id="pie"></canvas>
        </div>
    </div>
    <div class="d-flex align-items-center mt-4 mb-2">
        <h3 class="me-auto mb-0">Play Log</h3>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="alert-toggle" checked>
            <label class="form-check-label" for="alert-toggle">Show Alerts</label>
        </div>
    </div>
    <div id="alert-box" class="alert alert-info d-none" role="alert"></div>
    <table class="table" id="play-table">
        <thead>
            <tr><th>Timestamp</th><th>Label</th><th>Confidence</th></tr>
        </thead>
        <tbody></tbody>
    </table>
    {% if stream_id %}
    <div class="mt-4">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/{{ stream_id }}" frameborder="0" allowfullscreen></iframe>
    </div>
    {% endif %}
</div>
<script>
let playChart;
let scouting = [];
fetch('/api/scouting').then(r => r.json()).then(data => { scouting = data; });

function showAlert(msg) {
    const box = document.getElementById('alert-box');
    if (!msg || !document.getElementById('alert-toggle').checked) return;
    box.textContent = msg;
    box.classList.remove('d-none');
    setTimeout(() => box.classList.add('d-none'), 7000);
}
function updatePlays() {
    fetch('/api/plays').then(r => r.json()).then(data => {
        const tbody = document.querySelector('#play-table tbody');
        tbody.innerHTML = '';
        data.forEach(p => {
            const tr = document.createElement('tr');
            const conf = (p.confidence || 0).toFixed(2);
            tr.innerHTML = `<td>${p.timestamp}</td><td>${p.label}</td><td>${conf}</td>`;
            tbody.appendChild(tr);
        });
        const counts = {};
        data.forEach(p => { counts[p.label] = (counts[p.label] || 0) + 1; });
        const labels = Object.keys(counts);
        const values = Object.values(counts);
        if (playChart) {
            playChart.data.labels = labels;
            playChart.data.datasets[0].data = values;
            playChart.update();
        } else {
            playChart = new Chart(document.getElementById('pie'), {
                type: 'pie',
                data: { labels: labels, datasets: [{ data: values }] },
                options: { responsive: true }
            });
        }
        const last = data[data.length - 1];
        if (last && scouting.length) {
            const form = (last.formation || '').toLowerCase();
            let q = last.quarter;
            if (!q && last.timestamp) {
                const m = /Q(\d)/.exec(last.timestamp);
                if (m) q = parseInt(m[1]);
            }
            const pat = scouting.find(s =>
                s.formation.toLowerCase() === form && parseInt(s.quarter) === parseInt(q)
            );
            if (pat) {
                const conf = last.confidence ? ` (${(last.confidence * 100).toFixed(0)}%)` : '';
                showAlert(`\uD83D\uDCA1 High ${pat.play} rate from ${pat.formation} in Q${pat.quarter} - Predicted: ${last.label}${conf}`);
            }
        }
    });
}
function updateScore() {
    fetch('/api/score').then(r => r.json()).then(score => {
        document.getElementById('mca-score').value = score.MCA;
        document.getElementById('opp-score').value = score.Opp;
        document.getElementById('score-display').textContent = `${score.MCA} - ${score.Opp}`;
    });
}
document.getElementById('score-form').addEventListener('submit', e => {
    e.preventDefault();
    const payload = {
        MCA: parseInt(document.getElementById('mca-score').value) || 0,
        Opp: parseInt(document.getElementById('opp-score').value) || 0
    };
    fetch('/api/score', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(updateScore);
});
updateScore();
updatePlays();
setInterval(updatePlays, 5000);
</script>
</body>
</html>
